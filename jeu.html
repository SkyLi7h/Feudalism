<!DOCTYPE HTML>
<html>
  <head>
    <style>
      body {
        margin: 0;
		padding: 0;
		height: 100%;
		overflow:hidden;
      }
	  
	  html {
        margin: 0;
		padding: 0;
		height: 100%;
      }
    </style>
  </head>
  <body>
	<div id="scoreDiv" style="position: absolute; left: 10px; margin-top: -10px;"><h2><div id="point">0</div></h2></div>
	<div id="difficulte" style="position: absolute; right:10px; top: 5px;">Niveau : <div id="niveau">1</div></div>
    <canvas id="myCanvas"></canvas>
    <script>
	  var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
	  var lastTime = new Date().getTime();
	  var lastTimeModifVitesse = lastTime;
	  var lastTimeModifVitesseAModif = false;
	  var larg = (document.body.clientWidth);
	  var hauteur = (document.body.clientHeight);
	  canvas.width = larg;
	  canvas.height = hauteur;
	  var rec = [];
	  var longMin;
	  var longMax;
	  var hautMin;
	  var hautMax;
	  var vitesseMin;
	  var vitesseMax;
	  var recSeconde;
	  var nbRec = 0;
	  var nbMaxRec;
	  var tempsApparition;
	  
	  var largeurMoi = 25;
	  var hauteurMoi = 25;
	  var vitesseMoi = 13;
	  
	  var psy;
	  
	  var haut = false;
	  var bas = false;
	  var gauche = false;
	  var droite = false;
	  
	  var points = 0;
	  
	  var pause = false;
	  
	  var tabCouleur = [];
	  var tabCouleurExt = [];
	  
	  tabCouleur.push('#3399FF');
	  tabCouleur.push('#3366FF');
	  tabCouleur.push('#66CCFF');
	  tabCouleur.push('#00FF66');
	  tabCouleur.push('#FF00CC');
	  
	  
	 
	//CONFIG
	  var difficulte = 1;
	  
	  	  document.getElementById("niveau").innerHTML = difficulte;
	  
	  if(difficulte == 1)
	  {
		longMin = 15;
		longMax = 100;
		hautMin = 15;
		hautMax = 100;
		vitesseMin = 1;
		vitesseMax = 8;
		recSeconde = 3;
		nbMaxRec = 30;
		tempsApparition = 7000;
		psy = false;
	  }
	  
	  if(difficulte == 2)
	  {
		longMin = 10;
		longMax = 150;
		hautMin = 10;
		hautMax = 150;
		vitesseMin = 2;
		vitesseMax = 10;
		recSeconde = 4;
		nbMaxRec = 20;
		tempsApparition = 5000;
		psy = false;
	  }
	  
	  if(difficulte == 3)
	  {
		longMin = 5;
		longMax = 200;
		hautMin = 5;
		hautMax = 200;
		vitesseMin = 2;
		vitesseMax = 13;
		recSeconde = 5;
		nbMaxRec = 15;
		tempsApparition = 3000;
		psy = false;
	  }
	  
	  if(difficulte == 4)
	  {
		longMin = 5;
		longMax = 220;
		hautMin = 5;
		hautMax = 220;
		vitesseMin = 4;
		vitesseMax = 15;
		recSeconde = 7;
		nbMaxRec = 35;
		tempsApparition = 2500;
		psy = true;
	  }

	  
	  
	  var moi = new Rectangle(largeurMoi, hauteurMoi, (larg/2)-(largeurMoi/2), hauteur-100, vitesseMoi, '#808080', '#000000');
	  
	  window.onkeydown = function (event){
 
			if(event.keyCode == 38)
			{
				haut = true;
			}
			if(event.keyCode == 40)
			{
				bas = true;
			}
			if(event.keyCode == 39)
			{
				droite = true;
			}
			if(event.keyCode == 37)
			{
				gauche = true;
			}								 
		}
		
		window.onkeyup = function (event){
 
			if(event.keyCode == 38)
			{
				haut = false;
			}
			if(event.keyCode == 40)
			{
				bas = false;
			}
			if(event.keyCode == 39)
			{
				droite = false;
			}
			if(event.keyCode == 37)
			{
				gauche = false;
			}								 
		}
		
		function deplacement()
		{
			if(haut)
			{
				moi.y = moi.y - moi.vitesse;
			}
			
			if(bas)
			{
				moi.y = moi.y + moi.vitesse;
			}			
				
			if(droite)
			{
				moi.x = moi.x + moi.vitesse;
			}				
				
			if(gauche)
			{
				moi.x = moi.x - moi.vitesse;
			}		
		}
		
		

		
		function score(){
			points++;
			document.getElementById("point").innerHTML = points;
			
			if(!pause)
				setTimeout('score()',1000); /* rappel après 2 secondes = 2000 millisecondes */
		}
		
		function colision(moi, rec)
		{		
			if((moi.x >= rec.x + rec.largeur)      // trop à droite
				|| (moi.x + moi.largeur <= rec.x) // trop à gauche
				|| (moi.y >= rec.y + rec.hauteur) // trop en bas
				|| (moi.y + moi.hauteur <= rec.y))  // trop en haut
					  return false; 
			   else
					  return true;		
		}
		
		
	  
	  function animate(canvas, context, startTime) {

		var now = new Date().getTime();
	
		if(lastTime + tempsApparition < now && nbRec < nbMaxRec)
		{
			genRect()
			lastTime = now;
		}
	  
	     // clear
        context.clearRect(0, 0, canvas.width, canvas.height);
		
		for(i=0; i<rec.length; i++)
		{
			if(colision(moi, rec[i]))
				pause = true;
				
			if(lastTimeModifVitesse + 1000 < now && difficulte >= 3)
				{
					lastTimeModifVitesseAModif = true;
					rec[i].vitesse = aleatoire(vitesseMin, vitesseMax);
				}
			
			rec[i].y += rec[i].vitesse;			
			drawRectangle(rec[i], context, rec[i].couleur, rec[i].couleurExt);
			verifRectangle(rec[i], i);					
		}
		
		if(lastTimeModifVitesseAModif)
		{
			lastTimeModifVitesse = now;
			lastTimeModifVitesseAModif = false;
		}
		
		deplacement();
		drawRectangle(moi, context, moi.couleur, moi.couleurExt);
		

		if(!pause)
		{
			// request new frame
			requestAnimFrame(function() {
			  animate(canvas, context);
			});
		}
        
      }
	  
	  function verifRectangle(rec, i)
	  {
		if((rec.y - rec.hauteur) > hauteur)
		{
			regenRec(rec, i);
		}
	  
	  }
	  
	  function regenRec(rec, i)
	  {
		var x = aleatoire(0, larg);
		var vitesse = aleatoire(vitesseMin, vitesseMax);
		var l = aleatoire(longMin, longMax);
		var h = aleatoire(hautMin, hautMax);
		
		rec.x = x;
		rec.y = 0 - h;
		rec.vitesse = vitesse;
		rec.largeur = l;
		rec.hauteur = h;
	  }

	  function Rectangle(l, h, x, y, vitesse, couleur, couleurExt)
	  {
		this.largeur = l;
		this.hauteur = h;
		this.x = x;
		this.y = y;
		this.vitesse = vitesse;	  
		this.couleur = couleur;
		this.couleurExt = couleurExt;
	  }
	  
	  function genRect()
	  {
		for (var i=0; i<recSeconde; i++)
		  {
		  
				var x = aleatoire(0, larg);
				var vitesse = aleatoire(vitesseMin, vitesseMax);
				var l = aleatoire(longMin, longMax);
				var h = aleatoire(hautMin, hautMax);
				var y = 0 - h;
				var couleur = '#8ED6FF';
				var couleurExt = '#3399FF';
				
				if(psy)
				{
					couleur = tabCouleur[aleatoire(0, tabCouleur.length)];
					couleurExt = tabCouleur[aleatoire(0, tabCouleur.length)];
				}
				
				
				rec.push(new Rectangle(l, h, x, y, vitesse, couleur, couleurExt));
		  
		  }
		  
		  nbRec += recSeconde; 
	  }
		
	function aleatoire(min, max) { 
		return (Math.floor((max-min)*Math.random())+min); 
		} 

	  
	  function drawRectangle(myRectangle, context, couleur, couleurExt) {
	  
		context.beginPath();
		context.fillStyle = couleurExt;
		context.rect(myRectangle.x, myRectangle.y+myRectangle.hauteur, myRectangle.largeur, 6);      
        context.fill();
		
		context.beginPath();
		context.fillStyle = couleur;
        context.rect(myRectangle.x, myRectangle.y, myRectangle.largeur, myRectangle.hauteur);
        context.fill();


		
      }
	  
	   window.requestAnimFrame = (function(callback) {
        return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
        function(callback) {
          window.setTimeout(callback, 1000 / 60);
        };
      })();
	
	genRect();
	animate(canvas, context);
	score();
    </script>
  </body>
</html> 